<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸŒ³ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© (Ù…Ø­Ù…ÙŠØ©)</title>
<style>
  /* Basic styling (RTL-friendly) */
  body{font-family:Arial, Tahoma, sans-serif;background:#f0f9f4;margin:0;padding:0}
  header{background:#2d6a4f;color:#fff;padding:12px 16px;display:flex;align-items:center;gap:12px;justify-content:space-between}
  header h1{margin:0;font-size:18px}
  .header-actions{display:flex;gap:8px;align-items:center}
  .controls{display:flex;justify-content:center;flex-wrap:wrap;gap:8px;padding:12px}
  .controls input,.controls select,.controls button{padding:8px;border-radius:6px;border:1px solid #888;font-size:14px}
  .controls button{cursor:pointer}
  .tree-container{display:flex;justify-content:center;margin:12px;overflow:auto;position:relative}
  ul{position:relative;padding-bottom:40px;display:flex;justify-content:flex-start}
  li{list-style:none;margin:0 10px;padding:10px 5px 0 5px;position:relative;text-align:center}
  .member{padding:10px 15px;border-radius:50px;background:#74c69d;color:#1b4332;font-weight:bold;display:inline-block;box-shadow:0 3px 6px rgba(0,0,0,.2);cursor:pointer;z-index:2}
  .member-comment{margin-left:6px;cursor:pointer}
  .member-controls{margin-top:6px;display:flex;gap:6px;justify-content:center}
  .member-controls button{padding:4px 8px;border-radius:6px;border:none;cursor:pointer}
  .highlight{background:#ffc107 !important}
  .connector{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1}
  @media print{header,.controls,.member-controls,.member-comment,button{display:none!important};body{background:white}}
  /* Modals */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9999;align-items:center;justify-content:center}
  .modal .box{background:#fff;border-radius:8px;padding:18px;max-width:420px;width:92%;text-align:right;direction:rtl}
  .modal .box h3{margin:0 0 10px}
  .modal input{width:100%;padding:8px;margin-top:8px;border:1px solid #ccc;border-radius:6px}
  .modal .row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .btn{padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
  .btn-primary{background:#2d6a4f;color:#fff}
  .btn-ghost{background:#e9ecef;color:#111}
</style>
</head>
<body>
<header>
  <h1 id="title">ğŸŒ³ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h1>
  <div class="header-actions">
    <button id="langToggle">English</button>
    <button id="adminLoginBtn">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</button>
    <button id="changePassBtn" style="display:none">ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
  </div>
</header>

<div class="controls" id="controlPanel">
  <input type="text" id="nameInput" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…" />
  <select id="parentSelect"><option value="">(Ø¬Ø°Ø±)</option></select>
  <button id="addBtn">Ø¥Ø¶Ø§ÙØ©</button>

  <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…" />
  <button id="searchBtn">Ø¨Ø­Ø«</button>

  <button id="saveBtn">ğŸ’¾ Ø­ÙØ¸</button>
  <button id="printTreeBtn">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ø¬Ø±Ø©</button>
  <button id="printBranchBtn">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ±Ø¹</button>
  <button id="zoomOutBtn">-</button>
  <button id="zoomInBtn">+</button>
</div>

<div class="tree-container" id="treeContainer">
  <ul id="familyTree"></ul>
  <svg class="connector" id="connectorLayer"></svg>
</div>

<!-- Admin Login Modal -->
<div class="modal" id="loginModal" aria-hidden="true">
  <div class="box">
    <h3>ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
    <input id="loginPasswordInput" type="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    <div class="row">
      <button class="btn btn-ghost" id="cancelLoginBtn">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" id="confirmLoginBtn">Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>
</div>

<!-- Change Password Modal -->
<div class="modal" id="changeModal" aria-hidden="true">
  <div class="box">
    <h3>ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
    <input id="oldPassInput" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©" />
    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
    <input id="newPassInput" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (>=6 Ø­Ø±Ù)" />
    <div class="row">
      <button class="btn btn-ghost" id="cancelChangeBtn">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" id="confirmChangeBtn">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Save confirmation modal (optional extra) -->
<div class="modal" id="saveConfirmModal" aria-hidden="true">
  <div class="box">
    <h3>ğŸ’¾ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ÙØ¸</h3>
    <p>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„Ø´Ø¬Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Firebase)ØŸ</p>
    <div class="row">
      <button class="btn btn-ghost" id="dontPushBtn">Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·</button>
      <button class="btn btn-primary" id="pushToCloudBtn">Ø­ÙØ¸ ÙˆÙ…Ø²Ø§Ù…Ù†Ø©</button>
    </div>
  </div>
</div>

<!-- Firebase SDKs (namespaced) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>

<script>
/* ================= CONFIG ================= */
/* Replace these values with your Firebase project's config if you want cloud sync */
const firebaseConfig = {
  apiKey: "AIzaSyCzCF7pRUjlBe74nsCKv1JbiSk6CcG7n90",
  authDomain: "bariyab-f3cdd.firebaseapp.com",
  databaseURL: "https://bariyab-f3cdd-default-rtdb.firebaseio.com",
  projectId: "bariyab-f3cdd",
  storageBucket: "bariyab-f3cdd.appspot.com",
  messagingSenderId: "34506515407",
  appId: "1:34506515407:web:db853b37356a3de799a8ba"
};

/* Default admin password if none is stored remotely/local: */
const DEFAULT_ADMIN_PASSWORD = "1234";

/* ================= GLOBALS ================= */
let isAdmin = false;                     // read-only unless true
let adminPassword = DEFAULT_ADMIN_PASSWORD; // holds current password (loaded from Firebase or localStorage)
let treeData = JSON.parse(localStorage.getItem('familyTreeNatural')) || null;
let scaleLevel = 1;
let selectedNodeId = null;
let firebaseConnected = false;
let db = null;

/* ================= Initialize Firebase (optional) ================= */
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  firebaseConnected = true;
  // Try to load admin password from Firebase settings path if exists
  db.ref('settings/adminPassword').once('value').then(snap => {
    if (snap.exists() && snap.val()) {
      adminPassword = snap.val();
      localStorage.setItem('adminPassword', adminPassword);
    } else {
      // fallback to localStorage or default
      const local = localStorage.getItem('adminPassword');
      if (local) adminPassword = local;
      else localStorage.setItem('adminPassword', adminPassword);
    }
  }).catch(()=>{ /* ignore */ });

  // Real-time listener for tree updates (others' saves)
  db.ref('familyTreeNatural').on('value', snapshot => {
    const val = snapshot.val();
    if (val) {
      treeData = val;
      localStorage.setItem('familyTreeNatural', JSON.stringify(treeData));
      renderTree();
    }
  });

  console.log('Firebase initialized.');
} catch (e) {
  // If Firebase fails (e.g. offline), fall back to localStorage-only
  console.warn('Firebase init failed â€” running offline only.', e);
  const localPass = localStorage.getItem('adminPassword');
  if (localPass) adminPassword = localPass;
}

/* ================= UI helper: show/hide edit controls ================= */
function updateEditUI() {
  // Show or hide controls row (add/save) and member-controls
  document.getElementById('controlPanel').style.display = isAdmin ? 'flex' : 'none';
  // show/hide edit buttons inside buildTree by re-rendering
  renderTree();
  // show change password button in header only for admin
  document.getElementById('changePassBtn').style.display = isAdmin ? 'inline-block' : 'none';
}

/* ================= Localization (keeps your original Arabic-first UI) ================= */
const texts = {
  ar:{title:"ğŸŒ³ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© (Ø·Ø¨ÙŠØ¹ÙŠ)", add:"Ø¥Ø¶Ø§ÙØ©", search:"Ø¨Ø­Ø«", save:"ğŸ’¾ Ø­ÙØ¸", printTree:"Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ø¬Ø±Ø©", printBranch:"Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ±Ø¹", root:"(Ø¬Ø°Ø±)", namePh:"Ø§Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…", searchPh:"Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…", enterName:"Ø§Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…!", chooseBranch:"Ø§Ø®ØªØ± ÙØ±Ø¹Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹", notFound:"Ø§Ù„ÙØ±Ø¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯", commentPrompt:"Ø£Ø¶Ù Ø£Ùˆ Ø¹Ø¯Ù‘Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚:", noComment:"Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚", edit:"ØªØ¹Ø¯ÙŠÙ„", del:"Ø­Ø°Ù"},
  en:{title:"ğŸŒ³ Family Tree (Natural)", add:"Add", search:"Search", save:"Save", printTree:"Print Tree", printBranch:"Print Branch", root:"(Root)", namePh:"Enter name", searchPh:"Search name", enterName:"Enter a name!", chooseBranch:"Select a branch first", notFound:"Branch not found", commentPrompt:"Add or edit comment:", noComment:"No comment", edit:"Edit", del:"Delete"}
};
let currentLang = 'ar';
function setLang(lang){
  currentLang = lang;
  document.getElementById('title').textContent = texts[lang].title;
  document.getElementById('addBtn').textContent = texts[lang].add;
  document.getElementById('searchBtn').textContent = texts[lang].search;
  document.getElementById('saveBtn').textContent = texts[lang].save;
  document.getElementById('printTreeBtn').textContent = texts[lang].printTree;
  document.getElementById('printBranchBtn').textContent = texts[lang].printBranch;
  document.getElementById('nameInput').placeholder = texts[lang].namePh;
  document.getElementById('searchInput').placeholder = texts[lang].searchPh;
  document.getElementById('parentSelect').options[0].textContent = texts[lang].root;
  document.getElementById('langToggle').textContent = (lang==='ar'?'English':'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©');
  document.documentElement.dir = (lang==='ar')?'rtl':'ltr';
}
document.getElementById('langToggle').addEventListener('click', ()=> setLang(currentLang === 'ar' ? 'en' : 'ar'));
setLang('ar');

/* ================= Tree render / build / events ================= */
function renderTree(){
  const container = document.getElementById('familyTree');
  container.innerHTML = treeData ? buildTree(treeData,0) : '';
  localStorage.setItem('familyTreeNatural', JSON.stringify(treeData));
  refreshParentSelect();
  attachEvents();
  drawConnectors();
  // Ensure controls visibility
  // The controls row and edit buttons are hidden when isAdmin=false.
  // controls row visibility handled by updateEditUI
}
function buildTree(node,depth){
  if(!node) return '';
  let colors=["#2d6a4f","#40916c","#74c69d","#b5e48c","#ffd166","#ef476f"];
  let color = colors[depth % colors.length];
  let selectedClass = (selectedNodeId === node.id) ? 'highlight' : '';
  let commentIcon = node.comment ? 'ğŸ’¬' : 'ğŸ“';
  let commentTitle = node.comment ? node.comment : texts[currentLang].noComment;
  let controlsHTML = isAdmin ? `<div class="member-controls">
      <button class="edit-btn" data-id="${node.id}">${texts[currentLang].edit}</button>
      <button class="delete-btn" data-id="${node.id}">${texts[currentLang].del}</button>
    </div>` : '';
  let html = `<li>
    <div class="member ${selectedClass}" style="background:${color};" data-id="${node.id}">
      ${node.name}
      <span class="member-comment" data-id="${node.id}" title="${commentTitle}">${commentIcon}</span>
    </div>
    ${controlsHTML}`;
  if(node.children && node.children.length>0){
    html += `<ul style="justify-content:flex-start;">`;
    node.children.forEach(c => html += buildTree(c, depth+1));
    html += `</ul>`;
  }
  html += `</li>`;
  return html;
}

function attachEvents(){
  // comments (allowed for everyone)
  document.querySelectorAll('.member-comment').forEach(icon=>{
    icon.addEventListener('click', e=>{
      e.stopPropagation();
      const id = Number(icon.dataset.id);
      const node = findNode(treeData, id);
      if(!node) return;
      const comment = prompt(texts[currentLang].commentPrompt, node.comment || "");
      if(comment !== null){
        node.comment = comment.trim();
        saveLocalOnly();
        renderTree();
      }
    });
  });
  // select
  document.querySelectorAll('.member').forEach(m=>{
    m.addEventListener('click', ()=>{
      const id = Number(m.dataset.id);
      selectedNodeId = (selectedNodeId === id) ? null : id;
      renderTree();
    });
  });
  // edit (only exists in DOM if isAdmin)
  document.querySelectorAll('.edit-btn').forEach(btn=>{
    btn.addEventListener('click', e=>{
      e.stopPropagation();
      const id = Number(btn.dataset.id);
      const node = findNode(treeData, id);
      if(!node) return;
      const newName = prompt(currentLang==='ar' ? 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯' : 'Enter new name', node.name);
      if(newName && newName.trim()){
        node.name = newName.trim();
        saveLocalOnly();
        renderTree();
      }
    });
  });
  // delete
  document.querySelectorAll('.delete-btn').forEach(btn=>{
    btn.addEventListener('click', e=>{
      e.stopPropagation();
      const id = Number(btn.dataset.id);
      if(confirm(currentLang==='ar' ? 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶ÙˆØŸ' : 'Delete this member?')){
        treeData = deleteNode(treeData, id);
        saveLocalOnly();
        renderTree();
      }
    });
  });
}

/* ---------- local save helpers ---------- */
function saveLocalOnly(){
  localStorage.setItem('familyTreeNatural', JSON.stringify(treeData));
}

/* ---------- add member ---------- */
document.getElementById('addBtn').addEventListener('click', ()=>{
  if(!isAdmin){ alert(currentLang==='ar' ? 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ø¥Ø¶Ø§ÙØ©' : 'Admin login required to add'); return; }
  const name = document.getElementById('nameInput').value.trim();
  const parentVal = document.getElementById('parentSelect').value;
  if(!name) return alert(texts[currentLang].enterName);
  const newNode = { id: Date.now() + Math.random(), name, children: [] };
  if(!treeData && (parentVal === "" || parentVal === null)) {
    treeData = newNode;
  } else if(treeData && parentVal) {
    const parentId = Number(parentVal);
    const parentNode = findNode(treeData, parentId);
    if(parentNode){
      if(!parentNode.children) parentNode.children = [];
      parentNode.children.push(newNode);
    } else {
      alert(texts[currentLang].notFound); return;
    }
  } else {
    alert(currentLang==='ar' ? 'Ø§Ù„Ø¬Ø°Ø± Ù…ÙˆØ¬ÙˆØ¯ â€” Ø§Ø®ØªØ± ÙˆØ§Ù„Ø¯Ù‹Ø§' : 'Root exists. Choose a parent.'); return;
  }
  document.getElementById('nameInput').value = '';
  saveLocalOnly();
  renderTree();
});

/* ---------- Save button behavior ---------- */
/* The Save button is available only when admin is logged-in.
   Clicking Save opens a simple confirm modal: push to Firebase (if connected) or save local only. */
document.getElementById('saveBtn').addEventListener('click', ()=>{
  if(!isAdmin){ alert(currentLang==='ar' ? 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©' : 'Admin login required to save'); return; }
  // show save confirm modal
  document.getElementById('saveConfirmModal').style.display = 'flex';
});
document.getElementById('dontPushBtn').addEventListener('click', ()=>{
  localStorage.setItem('familyTreeNatural', JSON.stringify(treeData));
  document.getElementById('saveConfirmModal').style.display = 'none';
  alert(currentLang==='ar' ? 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹' : 'Saved locally');
});
document.getElementById('pushToCloudBtn').addEventListener('click', ()=>{
  // push to firebase (if connected)
  if(firebaseConnected && db){
    db.ref('familyTreeNatural').set(treeData || null)
      .then(()=>{ document.getElementById('saveConfirmModal').style.display = 'none'; alert('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆÙ…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø´Ø¬Ø±Ø©'); })
      .catch(err=>{ console.error(err); alert('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ Firebase'); });
  } else {
    document.getElementById('saveConfirmModal').style.display = 'none';
    alert('âš ï¸ Firebase ØºÙŠØ± Ù…ØªØµÙ„ â€” Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
  }
});

/* ---------- Admin login modal logic ---------- */
const loginModal = document.getElementById('loginModal');
const loginPwInput = document.getElementById('loginPasswordInput');
document.getElementById('adminLoginBtn').addEventListener('click', ()=>{
  loginPwInput.value = '';
  loginModal.style.display = 'flex';
  loginPwInput.focus();
});
document.getElementById('cancelLoginBtn').addEventListener('click', ()=> loginModal.style.display = 'none');

document.getElementById('confirmLoginBtn').addEventListener('click', ()=>{
  const pw = loginPwInput.value;
  if(!pw) return;
  // if settings/adminPassword exists in Firebase, adminPassword variable will contain it (loaded earlier).
  // fallback to localStorage or default.
  if(pw === adminPassword){
    isAdmin = true;
    updateEditUI();
    loginModal.style.display = 'none';
    alert(currentLang==='ar' ? 'âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±' : 'Admin mode activated');
  } else {
    alert(currentLang==='ar' ? 'âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©' : 'Wrong password');
  }
});

/* ---------- Change password modal logic (requires admin) ---------- */
const changeModal = document.getElementById('changeModal');
const oldPassInput = document.getElementById('oldPassInput');
const newPassInput = document.getElementById('newPassInput');
document.getElementById('changePassBtn').addEventListener('click', ()=>{
  if(!isAdmin){ alert(currentLang==='ar' ? 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ± Ù„ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±' : 'Admin required to change password'); return; }
  oldPassInput.value = ''; newPassInput.value = '';
  changeModal.style.display = 'flex';
  oldPassInput.focus();
});
document.getElementById('cancelChangeBtn').addEventListener('click', ()=> changeModal.style.display = 'none');

document.getElementById('confirmChangeBtn').addEventListener('click', ()=>{
  const oldPw = oldPassInput.value;
  const newPw = newPassInput.value;
  if(oldPw !== adminPassword){ alert(currentLang==='ar' ? 'âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©' : 'Current password incorrect'); return; }
  if(!newPw || newPw.length < 6){ alert(currentLang==='ar' ? 'ÙŠØ¬Ø¨ Ø£Ù† ØªØªÙƒÙˆÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ù† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„' : 'New password must be >= 6 chars'); return; }

  // Save the new password to Firebase if available, otherwise localStorage
  if(firebaseConnected && db){
    db.ref('settings/adminPassword').set(newPw).then(()=>{
      adminPassword = newPw;
      localStorage.setItem('adminPassword', newPw);
      changeModal.style.display = 'none';
      alert(currentLang==='ar' ? 'âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±' : 'Password updated');
    }).catch(err=>{
      console.error(err);
      alert('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
    });
  } else {
    adminPassword = newPw;
    localStorage.setItem('adminPassword', newPw);
    changeModal.style.display = 'none';
    alert(currentLang==='ar' ? 'âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø­Ù„ÙŠØ§Ù‹' : 'Password updated locally');
  }
});

/* ---------- Search ---------- */
document.getElementById('searchBtn').addEventListener('click', ()=>{
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  document.querySelectorAll('.member').forEach(m => {
    if(m.textContent.toLowerCase().includes(q)) m.classList.add('highlight'); else m.classList.remove('highlight');
  });
});

/* ---------- Printing ---------- */
document.getElementById('printTreeBtn').addEventListener('click', ()=>{
  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>${texts[currentLang].printTree}</title><style>body{font-family:Arial,sans-serif}.member{display:inline-block;padding:10px 15px;border-radius:50%;margin:4px;font-weight:bold;color:white}</style></head><body><div id="root"></div></body></html>`);
  w.document.close();
  const clone = document.getElementById('treeContainer').cloneNode(true);
  clone.style.transform = 'scale(.9)';
  w.document.getElementById('root').appendChild(clone);
  setTimeout(()=>{ drawPrintConnectors(clone, clone.querySelector('#connectorLayer')); w.focus(); w.print(); }, 200);
});

document.getElementById('printBranchBtn').addEventListener('click', ()=>{
  if(!selectedNodeId) return alert(texts[currentLang].chooseBranch);
  const node = findNode(treeData, selectedNodeId);
  if(!node) return alert(texts[currentLang].notFound);
  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>${texts[currentLang].printBranch}</title><style>body{font-family:Arial,sans-serif}.member{display:inline-block;padding:10px 15px;border-radius:50%;margin:4px;font-weight:bold;color:white;background:#95d5b2}</style></head><body><div id="root"></div></body></html>`);
  w.document.close();
  function cloneBranch(n){
    let html = `<li><div class="member">${n.name}</div>`;
    if(n.children && n.children.length){ html += '<ul>'; n.children.forEach(c=> html += cloneBranch(c)); html += '</ul>'; }
    html += '</li>'; return html;
  }
  const ul = document.createElement('ul');
  ul.innerHTML = cloneBranch(node);
  const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
  svg.classList.add('connector');
  svg.style.position = 'absolute'; svg.style.top='0'; svg.style.left='0'; svg.style.width='100%'; svg.style.height='100%';
  const container = w.document.getElementById('root');
  container.appendChild(ul); container.appendChild(svg);
  setTimeout(()=>{ drawPrintConnectors(container, svg); w.focus(); w.print(); }, 200);
});

/* ---------- Helpers: find/delete/collect ---------- */
function findNode(node, id){
  if(!node) return null;
  if(node.id === id) return node;
  if(node.children) for(let c of node.children){ const f = findNode(c, id); if(f) return f; }
  return null;
}
function deleteNode(node, id){
  if(!node) return null;
  if(node.id === id) return null;
  if(node.children) node.children = node.children.map(c => deleteNode(c, id)).filter(Boolean);
  return node;
}
function collectNodes(node, out=[]){
  out.push({id: node.id, name: node.name});
  if(node.children) node.children.forEach(c => collectNodes(c, out));
  return out;
}
function refreshParentSelect(){
  const sel = document.getElementById('parentSelect');
  sel.innerHTML = `<option value="">${texts[currentLang].root}</option>`;
  if(treeData) collectNodes(treeData).forEach(n=>{
    const opt = document.createElement('option'); opt.value = n.id; opt.textContent = n.name; sel.appendChild(opt);
  });
}

/* ---------- Connectors ---------- */
document.getElementById('zoomInBtn').addEventListener('click', ()=>{ scaleLevel += 0.1; document.getElementById('treeContainer').style.transform = `scale(${scaleLevel})`; });
document.getElementById('zoomOutBtn').addEventListener('click', ()=>{ scaleLevel = Math.max(0.3, scaleLevel - 0.1); document.getElementById('treeContainer').style.transform = `scale(${scaleLevel})`; });

function drawConnectors(){
  const svg = document.getElementById('connectorLayer'); if(!svg) return;
  svg.innerHTML = '';
  const members = document.querySelectorAll('.member');
  members.forEach(m=>{
    const li = m.closest('li'); const parentLi = li.parentElement.closest('li');
    if(parentLi){
      const parentMember = parentLi.querySelector('.member');
      if(parentMember){
        const mRect = m.getBoundingClientRect(), pRect = parentMember.getBoundingClientRect(), svgRect = svg.getBoundingClientRect();
        const x1 = pRect.left + pRect.width/2 - svgRect.left + window.scrollX;
        const y1 = pRect.top + pRect.height/2 - svgRect.top + window.scrollY;
        const x2 = mRect.left + mRect.width/2 - svgRect.left + window.scrollX;
        const y2 = mRect.top - svgRect.top + window.scrollY;
        const path = document.createElementNS("http://www.w3.org/2000/svg","path");
        path.setAttribute("d", `M${x1},${y1} C${x1},${(y1+y2)/2} ${x2},${(y1+y2)/2} ${x2},${y2}`);
        path.setAttribute("stroke", "#2d6a4f"); path.setAttribute("stroke-width","3"); path.setAttribute("fill","none");
        svg.appendChild(path);
      }
    }
  });
  const container = document.getElementById('treeContainer');
  svg.setAttribute("width", container.scrollWidth);
  svg.setAttribute("height", container.scrollHeight);
}


function drawPrintConnectors(container, svg){
  svg.innerHTML = '';
  const members = container.querySelectorAll('.member');
  members.forEach(m=>{
    const li = m.closest('li');
    const parentLi = li.parentElement.closest('li');
    if(parentLi){
      const parentMember = parentLi.querySelector('.member');
      if(parentMember){
        // Measure relative to the print container, not the viewport
        const containerRect = container.getBoundingClientRect();
        const mRect = m.getBoundingClientRect();
        const pRect = parentMember.getBoundingClientRect();

        const x1 = pRect.left + pRect.width/2 - containerRect.left;
        const y1 = pRect.top + pRect.height - containerRect.top;
        const x2 = mRect.left + mRect.width/2 - containerRect.left;
        const y2 = mRect.top - containerRect.top;

        const path = document.createElementNS("http://www.w3.org/2000/svg","path");
        path.setAttribute("d", `M${x1},${y1} C${x1},${(y1+y2)/2} ${x2},${(y1+y2)/2} ${x2},${y2}`);
        path.setAttribute("stroke", "#000");
        path.setAttribute("stroke-width", "2");
        path.setAttribute("fill", "none");
        svg.appendChild(path);
      }
    }
  });
  // Resize SVG to fit printed content
  const bounds = container.getBoundingClientRect();
  svg.setAttribute("width", bounds.width);
  svg.setAttribute("height", bounds.height);
}
/* ---------- Start ---------- */
/* Hide editing UI by default */
isAdmin = false;
updateEditUI();
/* Render initial tree from localStorage or firebase-loaded value */
renderTree();
/* Recalculate connectors on resize */
window.addEventListener('resize', drawConnectors);
</script>
</body>
</html>

